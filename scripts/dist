#!/bin/bash
set -euo pipefail
IFS=$'/n/t'
trap 'echo FATAL ERROR EXIT CODE $? AT $0:$LINENO' ERR

# ./scripts/dist
# WITH_CUDA=true ./scripts/dist
# WSL=true WITH_CUDA=true ./scripts/dist

INSTALL_CUDA_DRIVERS="true"

if test "${WITH_CUDA:-}" == "true" ; then
    WITH_CUDA=".WITH_CUDA"

    INSTALL_CUDA_DRIVERS="./install-cuda-drivers"

    # CUDA binaries appear to be WSL specific (give black screen on real Ubuntu an processing takes 0 time...)
    if test ! -z "${WSL:-}" ; then
        WSL=".WSL"
    else
    	WSL=""
    fi
else
    WITH_CUDA=""
    WSL=""
fi

mkdir -p dist

cp --verbose ./InfiniTAM/build/Apps/InfiniTAM_cli/InfiniTAM_cli "./dist/InfiniTAM_cli$WSL$WITH_CUDA"
cp --verbose ./InfiniTAM/build/Apps/InfiniTAM/InfiniTAM "./dist/InfiniTAM$WSL$WITH_CUDA"
cp --verbose ./data/download-teddy ./dist
cp --verbose ./scripts/install-cuda-drivers ./dist

# libglut.so.3: dynamically linked runtime dependency:
function f() {
    output="./dist/InfiniTAM$1.with-teddy$WSL$WITH_CUDA.sh"

    echo -n "#!/bin/bash
    set -euo pipefail
    ./download-teddy
    
    test -f /usr/lib/x86_64-linux-gnu/libglut.so.3 || sudo apt-get install -y freeglut3 || ( sudo apt-get update && sudo apt-get install -y freeglut3 ) 

    function run() {
        ./InfiniTAM$1$WSL$WITH_CUDA Teddy/calib.txt 'Teddy/Frames/%04i.ppm' 'Teddy/Frames/%04i.pgm'
    }
    run || ($INSTALL_CUDA_DRIVERS && run) || {
        echo 'STILL NOT WORKING You will need to reboot for any newly installed nvidia driver to work!'
        exit 1
    }
    " > "$output"
    chmod +x "$output"
}

f ''
f '_cli'
